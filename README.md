# 履修最適化ツール (Course Registration Optimizer)

## 概要

このツールは、大学の授業データ（CSV）を元に、ユーザーが設定した制約（必修科目、単位数、空きコマなど）に基づいて最適な履修計画の候補を複数生成するコマンドラインツールです。
主にICU（国際基督教大学）の授業データ形式に対応するように設計されていますが、データ形式を合わせれば他大学でも応用可能です。

## 特徴

- **データ整形**: 複雑な形式の授業時間割CSVを、プログラムで扱いやすい標準的なCSV形式に変換します。
- **パターン抽出**: 過去のデータや現状のデータから、共通する時間割パターン（例: 「月3, 水3, 金3」など）を自動抽出し、最適化のベースとして利用します。
- **高度な最適化**:
    - 必修科目、除外科目、優先科目の指定
    - 単位数の下限・上限設定
    - 全休曜日や不可コマ（アルバイトや部活など）の設定
    - 科目レベル（番台）によるフィルタリング
- **対話型編集**: 生成された候補を選択し、その場で科目の追加・削除を行って微調整できます。 `list` コマンドで追加・入れ替え可能な候補をツリー形式で確認可能です。
- **カレンダー出力**: 確定した時間割をiCalendar形式（.ics）で出力し、GoogleカレンダーやOutlookにインポート可能です。学期の開始日・終了日も指定でき、変則的な授業時間にも対応しています。
- **代替候補の提案**: パターン一覧表示時に、各科目の時間に収まる「入れ替え候補」を自動的に提示します（必修科目を除く）。
- **柔軟な設定**: `user_settings.json` を編集するだけで、コードを変更することなく条件を調整可能です。
- **外部依存なし**: Pythonの標準ライブラリのみで動作するため、環境構築が容易です。

## 必要要件

- Python 3.8 以上
- 外部ライブラリのインストールは不要です。

## ファイル構成

```
.
├── src/                     # Pythonスクリプト
│   ├── normalize_courses.py
│   ├── discover_patterns.py
│   ├── convert_period.py
│   └── optimize_courses.py
├── data/                    # データファイル
│   ├── 2025W - Sheet1.csv   # (入力) 大学からの元データ
│   ├── 2025W_normalized.csv # (生成) 正規化データ
│   ├── schedule_patterns.json # (生成) パターンデータ
│   ├── period.csv           # (入力) 時間割定義
│   └── period_times.json    # (生成) 時間割JSON
├── output/                  # 生成物
│   └── my_schedule.ics      # (生成) CSファイル
├── logs/                    # ログファイル
├── user_settings.json       # 設定ファイル
├── requirements.txt         # 依存関係
└── README.md                # 本ドキュメント
```

## 使用方法

### 1. データの準備

大学の授業スケジュールデータ（CSV形式）をプロジェクトルートに配置します。デフォルトでは `2025W - Sheet1.csv` というファイル名を想定しています。
また、時間割の定義ファイル `period.csv` も必要です。

### 2. 設定ファイルの編集

`user_settings.json` を開き、自身の履修計画に合わせて制約を設定します。

**設定例:**

```json
{
    "constraints": {
        "mandatory_nos": ["ELA060", "PHY261"],  // 絶対に取りたい科目
        "excluded_nos": ["HPE", "JLP"],         // 除外したい科目コードやプレフィックス
        "min_credits": 16,                      // 最小単位数
        "max_credits": 18,                      // 最大単位数
        "off_days": ["土", "日"],               // 全休にしたい曜日
        "unavailable_slots": [                  // 授業を入れたくない時間帯
            {"day": "月", "period": 1},
            {"day": "金", "period": 5}
        ]
    },
    "optimizer_settings": {
        "temperature": 50,                      // ランダム性の度合い (0-100)
        "max_candidates": 10                    // 出力する候補の数
    }
}
```

### 3. スクリプトの実行

以下の手順でコマンドを実行してください。

#### Step 1: データの前処理
データの正規化、パターン抽出、時間割定義の変換を行います。

```bash
# 授業データの整形
python src/normalize_courses.py

# 時間割パターンの抽出
python src/discover_patterns.py

# 時間割定義(period.csv)のJSON変換
python src/convert_period.py
```

#### Step 2: 最適化の実行と編集
設定ファイルに基づき、最適な時間割候補を生成して表示します。

```bash
python src/optimize_courses.py
```

実行すると、複数の候補が表示された後、対話モードになります。

**操作コマンド:**
- `select <番号>`: 候補を選択して編集モードに入ります（例: `select 1`）。
- `q`: 終了します。

**編集モード内のコマンド:**
- `add <科目番号>`: 科目を追加します（例: `add SOC101`）。
- `rm <科目番号>`: 科目を削除します（例: `rm SOC101`）。
- `list`: 追加可能な科目候補を表示します。「新規追加可能（競合なし）」な科目と、「既存科目との入れ替えで追加可能」な科目がツリー形式で表示されます（必修科目は除外されます）。
- `save`: 現在の時間割を `.ics` ファイルに出力して保存します。学期の開始日と終了日を指定可能です。
- `back`: 候補選択画面に戻ります。

## 出力イメージ

```text
==================================================
候補 #1
==================================================
合計単位数: 17

--- 候補科目 ---
  - [ELA060] Research Writing          3/M,5/TU,3/W,3/F
  - [PHY383] Quantum Mechanics         5/W,6/W
    (入れ替え候補: BIO101(2), ECO102(3), ...)
  ...

> select 1

------------------------------ 現在の時間割 ------------------------------
  ...
(edit) > list

--- 科目別入れ替え候補 ---
[PHY383] Quantum Mechanics ...
  - [BIO101] Introduction to Biology ...

--- 新規追加可能 (競合なし) ---
  [SOC101] Introduction to Sociology ...

(edit) > add SOC101
追加しました: Introduction to Sociology

(edit) > save
出力ファイル名 (default: my_schedule.ics): my_schedule.ics
カレンダーの種類を選択してください:
1. 平常 (Regular)
2. キリスト教週間 (Christian Week)
> 1
学期開始日 (YYYY-MM-DD) [Default: 2025-12-15]: 
学期終了日 (YYYY-MM-DD) [Default: 2026-02-23]: 

保存しました: my_schedule.ics
```

## トラブルシューティング

- **「ファイルが見つかりません」**: ファイル名がデフォルトと一致しているか確認してください。
- **Windowsで文字化けする場合**: スクリプトはUTF-8エンコーディングを想定しています。
- **変則時間の適用**: `period.csv` 内で `*` が付いているコマや、`period_times.json` で定義された変則条件に合致するコマは、自動的に変則時間が適用されてカレンダーに出力されます。
